<link rel="import" href="../../bower/polymer/polymer.html">

<dom-module id="app-store">
    <script>
        (function () {
            'use strict';

            let appActions, appReducer, appStore;

            class AppStore {
                beforeRegister() {
                    this.is = 'app-store';

                    // Define the properties object in beforeRegister.
                    this.properties = {
                        state: {
                            type: Object,
                            notify: true,
                            readOnly: true,
                            value: {quote: null, tickerSymbol: 'random'}
                        },
                        reducer: {
                            type: Object,
                            notify: true,
                            readOnly: false,
                            observer: '_updateReducers'
                        }
                    };
                }

                _updateReducers(reducer) {
                    appReducer = reducer;
                    // If anything changes, we only trigger at the top level
                    appStore = this;

                    appActions = appReducer.actions.reduce( (actions, action, i) => {
                            actions[action] = action;
                            return actions;
                        }, {});
                }

                ready() {}

                dispatch(action, data) {
                    if (action) {
                        appStore._setState(appReducer.transform(appStore.state, action, data));
                    } else {
                        throw 'Cannot dispatch an undefined action';
                    }
                }

                get actions() {
                    return appActions;
                }

                get state() { return appStore.state;}
            }

            Polymer(AppStore);
        })();
    </script>
</dom-module>
