<link rel="import" href="../../bower/polymer/polymer.html">
<link rel="import" href="../../bower/paper-input/paper-input.html">
<link rel="import" href="../../bower/paper-button/paper-button.html">
<link rel="import" href="../../bower/iron-icon/iron-icon.html">
<link rel='import' href="../../bower/iron-iconset-svg/iron-iconset-svg.html">
<link rel="import" href="../../bower/firebase-element/firebase-document.html">

<link rel="import" href="app-store.html">
<link rel="import" href="symbol-url.html">
<link rel="import" href="app-reducer.html">
<link rel="import" href="app-header.html">
<link rel="import" href="stock-view.html">
<link rel="import" href="stock-search.html">
<link rel="import" href="stock-details.html">
<link rel="import" href="quote-transform.html">

<dom-module id="stock-app">
    <style>
        :host {
            display: block;
        }

        #details {
          border: 2px solid #fff;
          border-radius: 3px;
          display: flex;
          flex-direction: column;
          justify-content: center;
          background-image: url(../img/background-blur.jpg);
          width: 400px;
          height: 400px;
        }
        paper-button.reload {
            background: #035177;
            opacity: .9;
            color: #fff;
        }
    </style>
    <template>
        <firebase-document id='fstats'
            location="https://polymer-redux.firebaseio.com/"
            log="true"
            data="{{fbState}}"></firebase-document>

        <app-store id="store" state="{{state}}" reducer="[[reducer]]"></app-store>
        <app-reducer id="reducer" filter="[[state.filter]]"></app-reducer>

        <app-ticker quote="[[state.quote]]" filter="[[state.filter]]"></app-ticker>
        <symbol-url symbol="[[state.filter.symbol]]"></symbol-url>

        <app-header hits="[[state.page.hits]]">
            <paper-button raised class="reload">Save app-state</paper-button>
        </app-header>

        <stock-view filter="[[state.filter]]" quote="[[state.quote]]" data="[[state.data]]">
            <article id="details">
              <stock-search symbol="[[state.filter.symbol]]"></stock-search>
              <stock-details quote="[[state.quote]]"></stock-details>
            <article>
        </stock-view>

        <footer>
        </footer>
    </template>
    <script>
        (function () {
            'use strict';

            class StockApp {
                // Element setup goes in beforeRegister instead of createdCallback.
                beforeRegister() {
                    this.is = 'stock-app';

                    // Define the properties object in beforeRegister.
                    this.properties = {
                        fbState: {
                            type: Object,
                            notify: true,
                            observer: 'updatedFbState'
                        },
                        reducer: {
                            type: Object,
                            notify: true
                        },
                        state: {
                          type: Object,
                          notify: true
                        }
                    };
                }

                updatedFbState() {
                    if (!this.state.page) {
                        this.$.store.dispatch(this.$.store.actions.INITIALIZE_STATE, {
                            page:   {hits: this.fbState.page.hits + 1} ,
                            filter: this.fbState.filter || this.state.filter,
                            quote:  this.fbState.quote,
                            graph:  this.fbState.graph});

                        setTimeout(() => {
                            this.fbState = Object.assign({}, this.fbState, {page: {hits: this.state.page.hits}});
                        }, 0);

                    } else {
                        if (this.fbState.page.hits > this.state.page.hits) {
                            this.$.store.dispatch(this.$.store.actions.PAGE_HIT_CHANGE, {hits: this.fbState.page.hits});
                        }
                    }
                }

                ready() {
                    this.state = this.$.store.state;
                    this.reducer = this.$.reducer;
                }
            }

            // Register the element using Polymer's constructor.
            Polymer(StockApp);
        })();
    </script>
</dom-module>
