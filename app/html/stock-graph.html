<link rel="import" href="../../bower/polymer/polymer.html">

<dom-module id="stock-graph">
    <style>
    </style>
    <template>
        <quote-transform quote="[[quote]]"></quote-transform>
        <div id="highcharts"></div>
    </template>
    <script>
        (function () {
            class StockGraph {

                // Element setup goes in beforeRegister instead of createdCallback.
                beforeRegister() {
                    this.is = 'stock-graph';

                    // Define the properties object in beforeRegister.
                    this.properties = {
                        quote: {
                            type: Object,
                            notify: true,
                            observer: 'updateQuote'
                        },
                        data: {
                          type: Array,
                          notify: true,
                          observer: 'updateData'
                        },
                        points: {
                            type: Number,
                            notify: true
                        }

                    };
                }

                ready() {
                    let self = this;
                    Highcharts.setOptions({
                        global: {
                            useUTC: false
                        }
                    });

                    this.chart = $(this.$.highcharts).highcharts({
                        chart: {
                            type: 'spline',
                            animation: Highcharts.svg,
                            height: 300,
                            marginRight: 10,
                            backgroundColor: 'transparent',
                            events: {
                                load: function () {
                                    // set up the updating of the chart each second
                                    self.series = this.series[0];
                                }
                            }
                        },
                        title: {
                            text: 'Live ' + this.tickersymbol + ' data'
                        },
                        xAxis: {
                            type: 'datetime',
                            tickPixelInterval: 150
                        },
                        yAxis: {
                            title: {
                                text: 'Value'
                            },
                            plotLines: [{
                                value: 0,
                                width: 1,
                                color: '#808080'
                            }]
                        },
                        tooltip: {
                            formatter: function () {
                                return '<b>' + this.series.name + '</b><br/>' +
                                        Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', this.x) + '<br/>' +
                                        Highcharts.numberFormat(this.y, 2);
                            }
                        },
                        legend: {
                            enabled: false
                        },
                        exporting: {
                            enabled: false
                        },
                        series: [{
                            name: 'Quote data',
                            data: []
                        }]
                    });

                }

/*
                updateTickerSymbol() {
                    this.series.setData([]);
                    this.dataCount = 0;

                    if (this.tickersymbol === 'random') {
                      $(this.$.highcharts).highcharts().setTitle({text: 'Random data'});
                      this.$.ticker.stop();
                      this.randomGen();
                    }
                    else if (this.tickersymbol) {
                      clearInterval(this.timer);
                      this.$.ticker.start();
                    }
                }
*/


                updatePoints() {
                    //debugger;
                }

                updateData() {
                    console.log('new data');
                    console.log(this.quote.LastTradePriceOnly);
                    let numberOfItems = this.data.length,
                        lastItem = this.data[numberOfItems - 1]

                    $(this.$.highcharts).highcharts().setTitle({text: `Live data from ${this.quote.Name}`});
                    this.series.addPoint(lastItem, true, this.series.data.length >= this.points);
                    /*
                    if (this.quote) {
                        let x = (new Date()), // current time
                            y = parseFloat(this.quote.LastTradePriceOnly);

                              // Yahoo quotes are delay by 15 minutes
                        x.setSeconds(x.getSeconds() - 900);

                        debugger;
                        this.$.store.dispatch(this.$.store.actions.ADD_DATA_ITEM, {item: [x.getTime(),y]});

                        $(this.$.highcharts).highcharts().setTitle({text: `Live data from ${this.quote.Name}`});
                        //this.series.addPoint([x,y], true, ++this.dataCount > 20);
                      }
                      */
                }
            }

            Polymer(StockGraph);
        })();
    </script>
</dom-module>
