<link rel="import" href="../../../bower/polymer/polymer.html">
<link rel="import" href="../app-store.html">

<dom-module id="stock-ticker">
    <template>
        <app-store id="store"></app-store>
    </template>

    <script>
        (function () {
            'use strict';

            class StockTicker {
                beforeRegister() {
                    this.is = 'stock-ticker';

                    this.properties = {
                        interval: {
                            type: Number,
                            notify: true,
                            observer: '_updateInterval'

                        },
                        symbol: {
                          type: String,
                          notify: true,
                          observer: '_updateSymbol'
                        }
                    };
                }

                async getQuote() {
                    let url = 'http://query.yahooapis.com/v1/public/yql';
                    let data = encodeURIComponent(`select * from yahoo.finance.quotes where symbol in ('${this.tickersymbol}')`);
                    let requestUrl = `${url}?q=${data}&format=json&diagnostics=true&env=http://datatables.org/alltables.env`;

                    let response = await fetch(requestUrl);

                    return response.text();
                }

                _runner() {
                  if (this.isRunning) {
                    console.log(this.interval);
                    this.timeoutId = setTimeout(() => {
                        if (this.tickersymbol) {
                            this.getQuote().then((response) => {
                                let json = JSON.parse(response);
                                if (this.isRunning) {
                                   this.$.store.dispatch(this.$.store.actions.QUOTE_CHANGE, {quote: json.query.results.quote})
                                }
                            });
                        }

                        if (this.isRunning) {
                          this._runner();
                        }
                    }, Math.max(1000, this.interval));
                }
              }

                start() {
                  if (!this.isRunning) {
                      this.isRunning = true;
                      this._runner();
                  }
                }

                stop() {
                  clearTimeout(this.timeoutId);
                  this.isRunning = false;
                }
            }

            // Register the element using Polymer's constructor.
            Polymer(StockTicker);
        })();
    </script>
</dom-module>
